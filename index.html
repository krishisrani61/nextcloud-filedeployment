<!DOCTYPE html>
<html>
<head>
  <title>Nextcloud Auth</title>
</head>
<body>
  <h1>Nextcloud Login</h1>
  <label for="server">Server URL:</label>
  <input type="text" id="server" placeholder="https://cloud.kisrani.com" />
  <button onclick="startAuth()">Start Login Flow</button>

  <div id="status"></div>
  <pre id="result"></pre>

  <script>
    async function startAuth() {
      const server = document.getElementById('server').value.trim();
      if (!server) {
        alert('Please enter a server URL');
        return;
      }

      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      statusEl.textContent = 'Starting login flow...';
      resultEl.textContent = '';

      try {
        const encodedUrl = encodeURIComponent(server + "/index.php/login/v2");
        const response = await fetch(`https://nextcloud-auth-proxy.ikrish61.workers.dev?url=${encodedUrl}`, {
          method: 'POST'
        });

        const data = await response.json();
        console.log("Login flow response:", data);

        // âœ… Corrected key names
        if (!data.poll || !data.poll.endpoint || !data.poll.token) {
          throw new Error("Missing poll endpoint or token in server response.");
        }

        const pollEndpoint = data.poll.endpoint;
        const token = data.poll.token;
        const login = data.login;

        statusEl.innerHTML = `Please authenticate at: <a href="${login}" target="_blank">${login}</a>`;

        let done = false;

        while (!done) {
          await new Promise(r => setTimeout(r, 1000));

          const pollResp = await fetch(pollEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token })
          });

          if (pollResp.status === 200) {
            const loginData = await pollResp.json();
            console.log("Auth success:", loginData);
            resultEl.textContent = JSON.stringify(loginData, null, 2);
            statusEl.textContent = 'Login successful!';
            done = true;
          } else if (pollResp.status !== 404) {
            throw new Error('Unexpected server response during polling.');
          }
        }

      } catch (e) {
        console.error("Login flow error:", e);
        statusEl.textContent = 'Login failed: ' + e.message;
      }
    }
  </script>
</body>
</html>
